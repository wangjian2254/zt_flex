<?xml version="1.0" encoding="utf-8"?>
<control:CBorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009" 
						  xmlns:s="library://ns.adobe.com/flex/spark" 
						  xmlns:mx="library://ns.adobe.com/flex/mx" xmlns:control="control.*" borderVisible="false" backgroundAlpha="0" width="900" height="700" xmlns:uicontrol="uicontrol.*" >
	<control:layout>
		<s:BasicLayout/>
	</control:layout>
	<fx:Script>
		<![CDATA[
			import events.CloseEvent;
			
			import httpcontrol.RemoteUtil;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.advancedDataGridClasses.AdvancedDataGridColumn;
			import mx.controls.advancedDataGridClasses.AdvancedDataGridColumnGroup;
			import mx.events.FlexEvent;
			import mx.events.ItemClickEvent;
			import mx.rpc.AbstractOperation;
			import mx.rpc.events.ResultEvent;
			import mx.utils.ObjectUtil;
			import mx.utils.StringUtil;
			
			import uicontrol.DDBHFliterComboBox;
			import uicontrol.PlanEndDate;
			import uicontrol.PlanStartDate;
			import uicontrol.PlanToSite;
			import uicontrol.SiteBox;
			
			import util.InfoUtil;
			[Bindable]
			public var showLabel:String;
			
			[bindable]
			private var headsitelist:ArrayCollection=new ArrayCollection();;
			
			override public function init(e:FlexEvent):void{
				
				orderbblist.removeAll();
				orderbbgrid.init(null);
				headBox.removeAllElements();
				var cbx:SiteBox=null;
				var siteGroup:AdvancedDataGridColumnGroup=null;
//				var zyq:AdvancedDataGridColumnGroup=new AdvancedDataGridColumnGroup();
//				zyq.headerText="作业区";
//				zyq.width=100;
//				orderbbgrid.groupedColumns=new Array();
//				orderbbgrid.groupedColumns.push(zyq);
				zyq.children.pop();
				var startDateColumn:AdvancedDataGridColumn=null;
				var endDateColumn:AdvancedDataGridColumn=null;
				var toSiteColumn:AdvancedDataGridColumn=null;
				for each(var item:Object in InfoUtil.siteList){
					cbx=new SiteBox();
					cbx.label=item.name;
					cbx.data = item;
					siteGroup=new AdvancedDataGridColumnGroup();
					siteGroup.headerText=item.name;
					
					startDateColumn=new AdvancedDataGridColumn();
					startDateColumn.headerText="投入日期";
					startDateColumn.editable=true;
					startDateColumn.editorDataField="data";
					startDateColumn.width=100;
					startDateColumn.dataField="startdate"+item.id;
					startDateColumn.itemEditor=new ClassFactory(PlanStartDate);
					
					endDateColumn=new AdvancedDataGridColumn();
					endDateColumn.headerText="完成日期";
					endDateColumn.editable=true;
					endDateColumn.editorDataField="data";
					endDateColumn.width=150;
					endDateColumn.dataField="enddate"+item.id;
					endDateColumn.itemEditor=new ClassFactory(PlanEndDate);
					
					toSiteColumn=new AdvancedDataGridColumn();
					toSiteColumn.headerText="转入位置";
					toSiteColumn.editable=true;
					toSiteColumn.editorDataField="data";
					toSiteColumn.width=80;
					toSiteColumn.dataField="zrwz"+item.id;
					toSiteColumn.itemEditor=new ClassFactory(PlanToSite);
					toSiteColumn.labelFunction=getZRWZStr;
					
					siteGroup.children.push(startDateColumn,endDateColumn,toSiteColumn);
					siteGroup.width=330;
					orderbbgrid.minWidth+=330;
					zyq.children.push(siteGroup);
					
					cbx.gridcolumn=siteGroup;
					cbx.selected=true;
					cbx.addEventListener(Event.CHANGE,refreshHeadGroup);
					headBox.addElement(cbx);
				}
				var columns:Array=new Array();
				for each(item in orderbbgrid.groupedColumns){
					columns.push(item);
				}
				orderbbgrid.groupedColumns=new Array();
				for each(item in columns){
					orderbbgrid.groupedColumns.push(item);
				}
				orderbbgrid.visible=true;
				
				
				orderbbgrid.invalidateList();
			}
			
			private function refreshHeadGroup(e:Event):void{
				var cbx:SiteBox=e.currentTarget as SiteBox;
				if(cbx!=null){
					if(cbx.selected){
						cbx.gridcolumn.visible=true;
						orderbbgrid.width+=330;
					}else{
						cbx.gridcolumn.visible=false;
						orderbbgrid.width-=330;
						
					}
				}
			}
			
			override public function closeContainer(e:CloseEvent):void{
				dispatchEvent(e);
				
			}
			
			private function getAllOpenProductSite():void{
				var op:AbstractOperation=RemoteUtil.getOperation("getAllOpenProductSite");
				op.addEventListener(ResultEvent.RESULT,resultAllOpenProductSite);
				RemoteUtil.openLoading();
				op.send();
			}
			
			private function resultAllOpenProductSite(e:ResultEvent):void{
				if(e.result.success){
					headsitelist.removeAll();
					headsitelist.addAll(new ArrayCollection(e.result.result as Array));
					
					
				}
			}
			
			private function refrashHead():void{
				headBox.removeAllElements();
				var cb:SiteBox;
				for each(var obj:Object in headsitelist){
					cb=new SiteBox();
					cb.label=obj.name;
					cb.selected=true;
//					cb.addEventListener(Event.CHANGE,changeHead);
					headBox.addElement(cb);
				}
			}
			
			
			
			public function getDDBHStr(item:Object, column:AdvancedDataGridColumn):String{
				if(InfoUtil.orderlistbhObj.hasOwnProperty("orderlist"+item.yddbh)){
					return InfoUtil.orderlistbhObj["orderlist"+item.yddbh];
				}
				for each(var obj:Object in InfoUtil.openOrderList){
					if(obj.id==item.yddbh){
						InfoUtil.orderlistbhObj["orderlist"+item.yddbh]=obj.ddbhstr;
						return obj.ddbhstr;
					}
				}
				
				return "";
			}
			
			public function getYWZStr(item:Object, column:AdvancedDataGridColumn):String{
				for each(var obj:Object in InfoUtil.siteList){
					if(obj.id==item.ywz){
						return obj.name;
					}
				}
				
				return "";
			}
			public function getZRWZStr(item:Object, column:AdvancedDataGridColumn):String{
				for each(var obj:Object in InfoUtil.siteList){
					if(obj.id==item[column.dataField]){
						return obj.name;
					}
				}
				
				return "";
			}
			
			public function getScxStr(item:Object, column:AdvancedDataGridColumn):String{
				for each(var obj:Object in InfoUtil.codeList){
					if(obj.id==item.code){
						for each(var obj1:Object in InfoUtil.scxList){
							if(obj1.id==obj.scx){
								return obj1.name;
							}
						}
					}
				}
				
				return "";
			}
			public function getCodeStr(item:Object, column:AdvancedDataGridColumn):String{
				if(InfoUtil.codeObj.hasOwnProperty("code"+item.code)){
					return InfoUtil.codeObj["code"+item.code];
				}
				for each(var obj:Object in InfoUtil.codeList){
					if(obj.id==item.code){
						InfoUtil.codeObj["code"+item.code]=obj.code;
						return obj.code;
					}
				}
				return "";
			}
			public function getCodeNameStr(item:Object, column:AdvancedDataGridColumn):String{
				if(InfoUtil.codeObj.hasOwnProperty("codename"+item.code)){
					return InfoUtil.codeObj["codename"+item.code];
				}
				for each(var obj:Object in InfoUtil.codeList){
					if(obj.id==item.code){
						InfoUtil.codeObj["codename"+item.code]=obj.name;
						return obj.name;
					}
				}
				return "";
			}
			public function getCodeGGStr(item:Object, column:AdvancedDataGridColumn):String{
				if(InfoUtil.codeObj.hasOwnProperty("codegg"+item.code)){
					return InfoUtil.codeObj["codegg"+item.code]
				}
				for each(var obj:Object in InfoUtil.codeList){
					if(obj.id==item.code){
						InfoUtil.codeObj["codegg"+item.code]=obj.gg;
						return obj.gg;
					}
				}
				return "";
			}
			
			//新增，保存，删除的处理函数
			private function clickHander(e:ItemClickEvent):void{
				
				if(e.label=="新增"){
					orderbblist.removeAll();
					this.lsh.text="";
				}
				if(e.label=="保存"){
					save();
				}
				if(e.label=="删除"){
					del();
				}
				if(e.label=="同步订单编号和物料"){
					InfoUtil.scxRefresh();
					InfoUtil.codeRefresh();
					InfoUtil.openOrderRefresh();

				}
				if(e.label=='同步数据'){
					if(this.lsh.text!=""){
					}
					
									}
			}
			
			public function del():void{
				var scxArr:ArrayCollection=new ArrayCollection();
				var obj:Object;
				var item:Object;
				for(var i:int=orderbblist.length-1;i>=0;i--){
					item=orderbblist.getItemAt(i);
					if(!item.selected){
						continue;
					}
					obj=new Object();
					if(item.hasOwnProperty("id")){
						obj.id=item.id;
						scxArr.addItem(obj);
					}else{
						orderbblist.removeItemAt(orderbblist.getItemIndex(item));
					}
					//					obj.name=item.name;
					
				}
				if(scxArr.length>0){
					var op:AbstractOperation=RemoteUtil.getOperation("delOrderBB");
					op.addEventListener(ResultEvent.RESULT,refreshDel);
					RemoteUtil.openLoading();
					op.send(scxArr);
				}
			}
			
			private function getGridGroupColumnByDataFiled(key:String):String{
//				var group:AdvancedDataGridColumnGroup=null;
				var column:AdvancedDataGridColumn=null;
				for(var i:Number=0;i<orderbbgrid.groupedColumns.length;i++){
					column=orderbbgrid.groupedColumns[i] as AdvancedDataGridColumn;
					if(column!=null&&column.dataField==key){
						return column.headerText;
					}
				}
				if(key.indexOf("startdate")==0){
					
				}
				if(key.indexOf("enddate")==0){
					
				}
				if(key.indexOf("zrwz")==0){
					
				}
				return null;
			}
			
			public function check():Boolean{
				var obj:Object;
				for(var ii:int=0;ii<orderbblist.length;ii++){
					
					obj=orderbblist.getItemAt(ii);
					obj['num']=ii+1;
				}
				var co:int=1;
				var flag:Boolean=false;
				var ydd:Boolean=false;
				var zdd:Boolean=false;
				var msg:String='';
				for(var i:int=0;i<orderbblist.length;i++){
					flag=false;
					ydd=false;
					zdd=false;
					obj=orderbblist.getItemAt(i);
					msg="第 "+(i+1)+" 行 ：";
					if(!obj.hasOwnProperty("yddbh")||obj["yddbh"]==""||obj["yddbh"]==null){
						Alert.show(msg+"源订单编号不能为空","提示");
						co=1;
						break;
					}
					if(!obj.hasOwnProperty("code")||obj["code"]==""||obj["code"]==null){
						Alert.show(msg+"物料不能为空","提示");
						co=2;
						break;
					}
					if(!obj.hasOwnProperty("plannum")||obj["plannum"]==""||obj["plannum"]==null||obj["plannum"]<=0){
						Alert.show(msg+"计划数量必须大于0","提示");
						co=7;
						break;
					}
//					orderbbgrid.get
					if(!obj.hasOwnProperty("zrddbh")||obj["zrddbh"]==""||obj["zrddbh"]==null){
						Alert.show(msg+"转入订单编号不能为空","提示");
						co=10;
						break;
					}
					if((obj["yddbh"]==obj["zrddbh"])&&(obj["ywz"]==obj["zrwz"])){
						Alert.show(msg+"源订单编号 与 转入订单编号 相同，且 转出位置 与 转入位置 也相同了。","提示");
						break;
					}
					co=0;
					if((!obj.hasOwnProperty("ywz")||obj["ywz"]==""||obj["ywz"]==null)&&(!obj.hasOwnProperty("zrwz")||obj["zrwz"]==""||obj["zrwz"]==null)){
						Alert.show(msg+"源位置与转入位置不能同时为空","提示");
						break;
					}
					if((!obj.hasOwnProperty("ywznum")||obj["ywznum"]==""||obj["ywznum"]==null)&&(!obj.hasOwnProperty("zrwznum")||obj["zrwznum"]==""||obj["zrwznum"]==null)){
						Alert.show(msg+"转出数量与转入数量不能同时为空","提示");
						break;
					}
					if(!obj.hasOwnProperty("ywz")||obj["ywz"]==""||obj["ywz"]==null){
						
					}else{
						if(obj["ywznum"]!=obj["zrwznum"]+obj["bfnum"]+obj["ysnum"]){
							Alert.show(msg+"转出数量不等于转入数量+报废数量+遗失数量+源位置剩余数量","提示");
							break;
						}
					}
					
					
					for each(var item:Object in InfoUtil.openOrderList){
						if(item.id==obj.yddbh){
							if(item.code==obj.code){
								ydd=true;
								obj.yorder=item.id;
							}
						}
						if(item.code==obj.code){
							if(item.id==obj.zrddbh){
								zdd=true;
								obj.zrorder=item.id;
							}
						}
						if(ydd&&zdd){
							break;
						}
					}
					if(!ydd){
						Alert.show(msg+"源订单没有选定的物料。","提示");
						break;
					}
					if(!zdd){
						Alert.show(msg+"转入订单没有选定的物料。","提示");
						break;
					}
					flag=true;
				}
				orderbbgrid.scrollToIndex(i);
				orderbbgrid.selectedIndex=i;
				if(co!=0){
					var v:Object=new Object;
					v.columnIndex=co+1;
					v.rowIndex=i;
					orderbbgrid.editedItemPosition=v;
				}
				orderbbgrid.invalidateList();
				return flag;
			}
			
			
			public function save():void{
				if(!check()){
					orderbblist.refresh();
					return;
				}
				var headList:ArrayCollection=new ArrayCollection();
				var sbx:SiteBox=null;
				for (var i:Number;i<headBox.numElements;i++){
					sbx=headBox.getElementAt(i) as SiteBox;
					if(sbx!=null){
						headList.addItem(sbx.data);
					}
				}
				
				
				var op:AbstractOperation=RemoteUtil.getOperation("updatePlan");
				op.addEventListener(ResultEvent.RESULT,saveResult);
				RemoteUtil.openLoading();
				op.send(headList,orderbblist);
				
				
				
			}
			
			private function saveResult(result:Object,e:ResultEvent):void{
				
			}
			
			public function trimStr(str:String):String{
				var _str:String=str;               
				while(_str.substr(0,1)==" "){
					_str=_str.substr(1);
				}
				while(_str.substr(-1,1)==" "){
					_str=_str.substr(0,_str.length-1);
				}
				return _str;
			}
			public function addItem():void{
				var codeStr:String=this.codeArea.text.replace("\r");
//				Alert.show(codeStr);
				var item:Object;
				for each(var code:String in codeStr.split("\n")){
					code=trimStr(code).toLowerCase();
					item=new Object();
					for each(var obj:Object in InfoUtil.codeList){
						if(obj.code.toLowerCase()==code){
							item.code=obj.id;
							item.codestr=obj.code;
							item.codename=obj.name;
							item.codegg=obj.gg;
							item.isModfy=true;
							item.selected=false;
							item.yddbh="";
							item.zrddbh="";
							item.ywz="";
							item.ywznum=0;
							item.zrwz="";
							item.zrwznum=0;
							item.bfnum=0;
							item.ysnum=0;
							item.ywzsynum=0;
							item.bztext="";
							orderbblist.addItem(item);
							break;
						}
					}
				}
				this.codeArea.text="";
			}
			
			
			
			public function refreshDel(e:ResultEvent):void{
				if(e.result.success){
					var item:Object;
					for each(var id:int in e.result.result){
						
						for(var i:int=orderbblist.length-1;i>=0;i--){
							item=orderbblist.getItemAt(i);
							if(item.id==id){
								orderbblist.removeItemAt(i);
							}
						}
					}
				}
			}
			
			

			
			
			
			[Bindable]
			public var orderbblist:ArrayCollection=new ArrayCollection();
			
			[Bindable]
			public var orderisopenlist:ArrayCollection=new ArrayCollection();
			
			[Bindable]
			private var buttonArr:ArrayCollection=new ArrayCollection([{'label':'新增','ico':addimg},{'label':'保存','ico':saveimg},{'label':'删除','ico':delimg},{'label':'同步数据','ico':refreshimg},{'label':'同步订单编号和物料','ico':refreshimg}]);
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<!-- 将非可视元素（例如服务、值对象）放在此处 -->
	</fx:Declarations>
	<s:HGroup top="8" right="8" bottom="8" left="8" gap="7">
		
		<s:BorderContainer width="100%" height="100%"  borderVisible="false" color="0x333333" skinClass="skins.contentBoxSkin">	
			<s:layout>
				<s:VerticalLayout gap="5">
					
				</s:VerticalLayout>
			</s:layout>
				<s:BorderContainer left="0" top="0" height="45" width="100%" borderVisible="false" backgroundImage="{CBorderContainer.toolbgimg}">
					<s:layout>
						<s:BasicLayout>
							
						</s:BasicLayout>
					</s:layout>
					<mx:ButtonBar dataProvider="{buttonArr}" doubleClickEnabled="true"  chromeColor="#faf0cc"  labelField="label" iconField="ico"  height="30" top="7" bottom="7" left="10" itemClick="clickHander(event);">
						
					</mx:ButtonBar>
					
				</s:BorderContainer>
				<s:BorderContainer id="codeAreaContainer" left="5" right="5" top="0" height="60" backgroundAlpha="0" borderVisible="false" >
					<s:layout>
						<s:HorizontalLayout gap="5" paddingLeft="10" horizontalAlign="left" verticalAlign="top">
							
						</s:HorizontalLayout>
					</s:layout>
					<s:Label text="物料代号:"/>
					<s:TextArea id="codeArea" width="400" height="100%"  >
						<s:text>
							A70170817
						</s:text>
					</s:TextArea>
					<s:Button label="提交" click="addItem()"/>
					<s:Label width="20"/>
					<s:Label text="流水号:" />
					<s:TextInput id="lsh" enabled="false">
					</s:TextInput>
				</s:BorderContainer>
			<s:Scroller width="100%" height="40" left="5" right="5">
				<s:Group width="100%" height="100%">
					<s:BorderContainer id="headBox"  height="40" backgroundAlpha="0" borderVisible="false" >
						<s:layout>
							<s:HorizontalLayout gap="10" paddingLeft="10" horizontalAlign="left" verticalAlign="top">
								
							</s:HorizontalLayout>
						</s:layout>
						
					</s:BorderContainer>
				</s:Group>
			</s:Scroller>
			<s:Scroller width="100%" height="100%">
				<s:Group width="100%" height="100%">
					
			<uicontrol:MarkAdvancedDataGrid id="orderbbgrid" isNewAdd="false" rowHeight="25" dataProvider="{orderbblist}" visible="false"  enabled="true" editable="true" height="100%">
				<uicontrol:groupedColumns>
					<mx:AdvancedDataGridColumn headerText="选择" itemRenderer="uicontrol.GridCheckBox" dataField="selected"  sortable="false" width="60"  editorDataField="selected" rendererIsEditor="true" >
						
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="序号" dataField="num"  sortable="false" width="60"  editable="false">
						
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="源订单编号" itemEditor="uicontrol.GridDDBH"  dataField="yddbh" editorDataField="data" labelFunction="getDDBHStr" width="100"   >
						
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="物料编号"  dataField="codestr"  editable="false"  width="100" >
						
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="物料名称"  dataField="codename" editable="false"  width="100" >
						
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="物料规格"  dataField="codegg" editable="false"   width="100">
						
					</mx:AdvancedDataGridColumn>
					
					<mx:AdvancedDataGridColumn headerText="生产线"  dataField="scx"  editable="false" labelFunction="getScxStr"  width="90" >
						
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="作业单号"    dataField="zydh"   width="100" >
						
					</mx:AdvancedDataGridColumn>
					
					<mx:AdvancedDataGridColumn headerText="计划数量" itemEditor="uicontrol.GridNum"  dataField="plannum" editorDataField="data"  width="80"  >
						
					</mx:AdvancedDataGridColumn>
					
					<mx:AdvancedDataGridColumnGroup id="zyq" headerText="作业区">
					<mx:AdvancedDataGridColumnGroup headerText="XX位置">
						<mx:AdvancedDataGridColumn headerText="计划投入日期" itemEditor="uicontrol.PlanStartDate"  dataField="startdate"   editorDataField="data"  width="100"  >
							
						</mx:AdvancedDataGridColumn>
						<mx:AdvancedDataGridColumn headerText="计划完成日期" itemEditor="uicontrol.PlanEndDate"  dataField="enddate"   editorDataField="data"  width="100"  >
							
						</mx:AdvancedDataGridColumn>
						<mx:AdvancedDataGridColumn headerText="去向位置" itemEditor="uicontrol.PlanToSite"  dataField="zrwz" editorDataField="data"  labelFunction="getZRWZStr" width="100"  >
							
						</mx:AdvancedDataGridColumn>
						
						
					</mx:AdvancedDataGridColumnGroup>
					</mx:AdvancedDataGridColumnGroup>
					
					<mx:AdvancedDataGridColumn headerText="订单要求说明"  dataField="bztext"   width="200"  >
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="要求工艺"  dataField="bztext"   width="200"  >
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="紧急程度"  dataField="bztext"   width="80"  >
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn headerText="在线可用数量"  dataField="bztext"   width="120"  >
					</mx:AdvancedDataGridColumn>
					
				</uicontrol:groupedColumns>
				
			</uicontrol:MarkAdvancedDataGrid>
				</s:Group>
			</s:Scroller>
		</s:BorderContainer>
	</s:HGroup>
</control:CBorderContainer>
